<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event-Driven Serverless System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #f8fafc; overflow: hidden; font-family: 'Inter', sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; padding: 1.5rem; display: flex; flex-direction: column; justify-content: space-between; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(0, 0, 0, 0.05); border-radius: 1rem; pointer-events: auto; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        
        .label { 
            position: absolute; 
            color: #475569; 
            font-size: 10px; 
            font-weight: 800; 
            text-transform: uppercase; 
            pointer-events: none; 
            transform: translate(-50%, -100%); 
            letter-spacing: 0.05em; 
            background: rgba(255, 255, 255, 0.85); 
            padding: 4px 10px; 
            border-radius: 6px; 
            white-space: nowrap; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .label-active { 
            color: #ea580c; 
            border-color: #fb923c; 
            transform: translate(-50%, -120%) scale(1.1); 
            box-shadow: 0 10px 15px -3px rgba(251, 146, 60, 0.2);
            background: white;
            z-index: 100;
        }
        
        /* Step Info Styles */
        #step-info-container {
            display: flex;
            gap: 12px;
            padding: 12px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #step-info-container::-webkit-scrollbar { display: none; }

        .step-card {
            min-width: 260px;
            max-width: 260px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.4;
            transform: translateY(10px);
            border: 1px solid transparent;
        }
        .step-card.active {
            opacity: 1;
            transform: translateY(0);
            background: white;
            border-color: #fb923c;
            box-shadow: 0 20px 25px -5px rgba(249, 115, 22, 0.1);
        }

        .step-number {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e2e8f0;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
        }
        .active .step-number { background: #f97316; color: white; }
    </style>
</head>
<body>

    <div id="ui">
        <!-- Top Header Area -->
        <div class="flex justify-between items-start w-full">
            <div class="glass p-5 border-l-4 border-orange-500">
                <h1 class="text-slate-900 text-xl font-black tracking-tight flex items-center gap-2">
                    <span class="w-2.5 h-2.5 bg-orange-500 rounded-full animate-pulse"></span>
                    EVENT-DRIVEN SERVERLESS SYSTEM
                </h1>
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-0.5">Automated Order Processing & Monitoring</p>
            </div>

            <div class="flex flex-col gap-3 items-end">
                <div id="status-box" class="glass px-5 py-3 text-slate-600 text-[11px] font-mono border-r-4 border-orange-500 hidden min-w-[280px]">
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="font-bold text-orange-600 uppercase">System Status: <span id="status-text">Idle</span></span>
                        <span id="progress-percent" class="font-black">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-orange-500 h-full w-0 transition-all duration-300"></div>
                    </div>
                </div>
                <button id="run-btn" class="glass px-8 py-4 text-white bg-slate-900 hover:bg-orange-600 font-bold uppercase tracking-widest text-xs transition-all transform active:scale-95 shadow-xl">
                    Submit Order Request
                </button>
            </div>
        </div>

        <!-- Bottom Step Detail Panel -->
        <div class="w-full flex justify-center">
            <div class="glass w-full max-w-6xl">
                <div id="step-info-container">
                    <!-- Cards injected here -->
                </div>
            </div>
        </div>
    </div>

    <div id="labels"></div>

    <script>
        let scene, camera, renderer, clock;
        const nodes = {};
        const labelsContainer = document.getElementById('labels');

        // UPDATED DATA ACCORDING TO USER PROJECT SPECS
        const AWS_DATA = [
            { id: 'user', name: 'Web Form / API', color: 0x64748b, pos: [-16, 0, 0], icon: 'https://img.icons8.com/ios-filled/100/222222/api.png', desc: 'The starting point where customer order details are submitted.' },
            { id: 'api', name: 'API Gateway', color: 0xe01563, pos: [-10, 0, 0], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/ApplicationIntegration/APIGateway.png', desc: 'Secure entry point that triggers the event-driven workflow.' },
            { id: 'lambda1', name: 'Validate Order', color: 0xff9900, pos: [-4, 0, 0], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/Compute/Lambda.png', desc: 'Serverless function that validates order syntax and authentication.' },
            { id: 'sqs', name: 'Order Queue', color: 0xe01563, pos: [2, 0, 0], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/ApplicationIntegration/SimpleQueueService.png', desc: 'Decouples services to ensure reliable processing during high demand.' },
            { id: 'lambda2', name: 'Process Engine', color: 0xff9900, pos: [8, 0, 0], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/Compute/Lambda.png', desc: 'Orchestrates the logging and notification events simultaneously.' },
            { id: 'db', name: 'Log to Database', color: 0x00a1e0, pos: [14, 2.5, -2], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/Database/DynamoDB.png', desc: 'Order details are logged permanently for tracking and inventory.' },
            { id: 'ses', name: 'Email Confirmation', color: 0xd93939, pos: [14, -2.5, -2], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/BusinessApplications/SimpleEmailService.png', desc: 'Sends an automated confirmation email to the customer.' },
            { id: 'cw', name: 'Monitoring (CloudWatch)', color: 0x8c4fff, pos: [0, 11, -6], icon: 'https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist/ManagementGovernance/CloudWatch.png', desc: 'Real-time logs and metrics monitoring for the entire pipeline.' }
        ];

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8fafc);
            scene.fog = new THREE.Fog(0xf8fafc, 30, 100);
            
            camera = new THREE.PerspectiveCamera(38, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 20, 45);
            camera.lookAt(0, 3, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.9));
            const light = new THREE.DirectionalLight(0xffffff, 0.4);
            light.position.set(10, 20, 10);
            scene.add(light);

            const grid = new THREE.GridHelper(100, 40, 0xe2e8f0, 0xf1f5f9);
            grid.position.y = -2.2;
            scene.add(grid);

            populateStepCards();
            createNodes();
            createFixedConnections();
            
            clock = new THREE.Clock();
            animate();

            document.getElementById('run-btn').onclick = runFullPipeline;
            window.onresize = onWindowResize;
        }

        function populateStepCards() {
            const container = document.getElementById('step-info-container');
            AWS_DATA.forEach((step, index) => {
                const card = document.createElement('div');
                card.id = `card-${step.id}`;
                card.className = 'step-card p-4 rounded-xl border border-slate-100 bg-white/40 flex flex-col gap-2';
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="step-number">${index + 1}</div>
                        <img src="${step.icon}" class="w-6 h-6 object-contain" />
                    </div>
                    <div class="mt-1">
                        <div class="text-[11px] font-black text-slate-800 uppercase tracking-tighter">${step.name}</div>
                        <p class="text-[10px] text-slate-500 leading-tight mt-1 font-medium">${step.desc}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function createNodes() {
            const loader = new THREE.TextureLoader();
            AWS_DATA.forEach(data => {
                const group = new THREE.Group();
                group.position.set(...data.pos);

                const platform = new THREE.Mesh(
                    new THREE.CylinderGeometry(1.5, 1.6, 0.25, 6),
                    new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.1, metalness: 0.05 })
                );
                group.add(platform);

                const ring = new THREE.Mesh(
                    new THREE.TorusGeometry(1.7, 0.04, 16, 100),
                    new THREE.MeshBasicMaterial({ color: data.color, transparent: true, opacity: 0.25 })
                );
                ring.rotation.x = Math.PI / 2;
                group.add(ring);

                const iconMat = new THREE.MeshBasicMaterial({ 
                    map: loader.load(data.icon), 
                    transparent: true,
                    side: THREE.DoubleSide
                });
                const icon = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), iconMat);
                icon.position.y = 1.4;
                group.add(icon);

                scene.add(group);
                nodes[data.id] = { group, ring, icon, data };

                const el = document.createElement('div');
                el.className = 'label';
                el.innerText = data.name;
                labelsContainer.appendChild(el);
                nodes[data.id].labelEl = el;
            });
        }

        function createFixedConnections() {
            const mat = new THREE.LineDashedMaterial({ 
                color: 0xe2e8f0, 
                dashSize: 0.4, 
                gapSize: 0.4 
            });
            const flows = [
                ['user', 'api'], ['api', 'lambda1'], ['lambda1', 'sqs'], 
                ['sqs', 'lambda2'], ['lambda2', 'db'], ['lambda2', 'ses'],
                ['api', 'cw'], ['lambda1', 'cw'], ['lambda2', 'cw']
            ];

            flows.forEach(f => {
                const points = [
                    new THREE.Vector3(...nodes[f[0]].data.pos),
                    new THREE.Vector3(...nodes[f[1]].data.pos)
                ];
                const geo = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(geo, mat);
                line.computeLineDistances();
                scene.add(line);
            });
        }

        async function runFullPipeline() {
            const btn = document.getElementById('run-btn');
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');
            const progressPercent = document.getElementById('progress-percent');
            
            btn.disabled = true;
            statusBox.classList.remove('hidden');

            const mainPath = ['user', 'api', 'lambda1', 'sqs', 'lambda2'];
            
            for (let i = 0; i < mainPath.length - 1; i++) {
                const from = mainPath[i];
                const to = mainPath[i+1];
                
                const progress = Math.round((i / (mainPath.length + 1)) * 100);
                progressBar.style.width = `${progress}%`;
                progressPercent.innerText = `${progress}%`;
                statusText.innerText = nodes[from].data.name;
                
                updateStepUI(from);
                pulseNode(from);

                // Monitoring log trigger
                if(['api', 'lambda1', 'lambda2'].includes(from)) {
                    movePacket(nodes[from].group.position, nodes['cw'].group.position, 0x8c4fff, 0.4, 1200);
                    updateStepUI('cw', false);
                }

                await movePacket(nodes[from].group.position, nodes[to].group.position, 0xffa500, 0.7, 850);
            }

            statusText.innerText = "Syncing Logs & Alerts";
            progressBar.style.width = `90%`;
            progressPercent.innerText = `90%`;
            updateStepUI('lambda2');
            pulseNode('lambda2');
            
            // Final dual events: DB Log and Email Notification
            await Promise.all([
                movePacket(nodes['lambda2'].group.position, nodes['db'].group.position, 0x00a1e0, 0.7, 1000),
                movePacket(nodes['lambda2'].group.position, nodes['ses'].group.position, 0xd93939, 0.7, 1000),
                (async () => {
                    await new Promise(r => setTimeout(r, 200));
                    updateStepUI('db', false);
                    updateStepUI('ses', false);
                })()
            ]);

            progressBar.style.width = `100%`;
            progressPercent.innerText = `100%`;
            statusText.innerText = "Order Complete";
            
            setTimeout(() => {
                btn.disabled = false;
                statusBox.classList.add('hidden');
                progressBar.style.width = `0%`;
                clearActiveSteps();
            }, 5000);
        }

        function updateStepUI(id, clear = true) {
            if (clear) clearActiveSteps();
            const card = document.getElementById(`card-${id}`);
            if (card) {
                card.classList.add('active');
                card.scrollIntoView({ behavior: 'smooth', inline: 'center' });
            }
        }

        function clearActiveSteps() {
            document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
        }

        function pulseNode(id) {
            const node = nodes[id];
            node.labelEl.classList.add('label-active');
            
            const startT = Date.now();
            function doPulse() {
                const elap = Date.now() - startT;
                const p = Math.min(elap / 600, 1);
                const s = 1 + Math.sin(p * Math.PI) * 0.15;
                node.group.scale.set(s, s, s);
                if (p < 1) requestAnimationFrame(doPulse);
                else {
                    node.group.scale.set(1,1,1);
                    setTimeout(() => node.labelEl.classList.remove('label-active'), 1200);
                }
            }
            doPulse();
        }

        function movePacket(start, end, color, size, duration) {
            const pGroup = new THREE.Group();
            const packet = new THREE.Mesh(
                new THREE.SphereGeometry(size, 24, 24),
                new THREE.MeshBasicMaterial({ color: color })
            );
            pGroup.add(packet);

            const trailGeo = new THREE.BufferGeometry();
            const trailMat = new THREE.LineBasicMaterial({ color, transparent: true, opacity: 0.3 });
            const trailLine = new THREE.Line(trailGeo, trailMat);
            
            scene.add(trailLine);
            scene.add(pGroup);

            const tPoints = [];

            return new Promise(res => {
                const startT = Date.now();
                function step() {
                    const elap = Date.now() - startT;
                    const prog = Math.min(elap / duration, 1);
                    
                    const cur = new THREE.Vector3().lerpVectors(start, end, prog);
                    const arc = (end.y > start.y) ? 2 : 3;
                    cur.y += Math.sin(prog * Math.PI) * arc;
                    
                    pGroup.position.copy(cur);
                    tPoints.push(cur.clone());
                    if (tPoints.length > 20) tPoints.shift();
                    trailLine.geometry.setFromPoints(tPoints);

                    if (prog < 1) requestAnimationFrame(step);
                    else { 
                        scene.remove(pGroup); 
                        scene.remove(trailLine);
                        res(); 
                    }
                }
                step();
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            Object.values(nodes).forEach(n => {
                const bob = n.data.id === 'cw' ? 0.4 : 0.2;
                n.group.position.y = n.data.pos[1] + Math.sin(time + n.data.pos[0] * 0.4) * bob;
                n.icon.rotation.y = Math.sin(time * 0.3) * 0.15;
                n.ring.rotation.z += 0.01;
                
                const vec = n.group.position.clone();
                vec.y += 3.2;
                vec.project(camera);
                const x = (vec.x * 0.5 + 0.5) * window.innerWidth;
                const y = (vec.y * -0.5 + 0.5) * window.innerHeight;
                n.labelEl.style.left = `${x}px`;
                n.labelEl.style.top = `${y}px`;
                n.labelEl.style.opacity = vec.z < 1 ? 1 : 0;
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
